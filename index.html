<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>POS — El Forastero</title>

  <!-- Tailwind (dark mode por clase) -->
  <script> window.tailwind = { config: { darkMode: 'class' } } </script>
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Tokens + utilidades minimal -->
  <style>
    :root{
      --surface:#ffffff; --surface-weak:#f6f7f9;
      --accent-50:#fff1f2; --accent-100:#ffe4e6;
      --accent-500:#f43f5e; --accent-600:#fb8c00;
    }
    html,body{height:100%}
    .container-grid{display:grid;grid-template-columns:repeat(12,minmax(0,1fr));gap:1rem}
    @media (min-width:1024px){ .container-grid{gap:1rem} }

    .card{ background:var(--surface); border-radius:1rem; border:1px solid rgba(15,23,42,.08); }
    .btn{ padding:.5rem .875rem; border-radius:.75rem; border:1px solid rgba(15,23,42,.10); background:#fff; }
    .btn:hover{ background:#f9fafb }
    .btn-primary{ border:none; background:var(--accent-600); color:#fff }
    .btn-primary:hover{ background:var(--accent-500) }
    .btn-ghost{ border-color:rgba(15,23,42,.10); background:#fff }
    .btn-ghost:hover{ background:#f9fafb }
    .inp{ border-radius:.75rem; border:1px solid #e5e7eb; padding:.5rem .75rem }
    .inp:focus{ outline:none; box-shadow:0 0 0 3px rgba(244,63,94,.15),0 0 0 1px var(--accent-500); border-color:var(--accent-500) }
    .navlink{ display:flex; gap:.625rem; align-items:center; padding:.5rem .75rem; border-radius:.75rem; color:#334155 }
    .navlink:hover{ background:#f3f4f6 }
    .navlink.active{ background:var(--accent-50); color:var(--accent-600) }
    .badge{ display:inline-flex; align-items:center; gap:.375rem; padding:.25rem .5rem; border-radius:999px; font-size:.75rem; color:#475569; background:#f3f4f6; }

    /* Tipografías en negro en todo el sitio */
    body { color:#000; }
    .text-slate-800,.text-slate-700,.text-slate-600,.text-slate-500,.text-slate-400,
    .text-gray-800,.text-gray-700,.text-gray-600,.text-gray-500,.text-gray-400 { color:#000 !important; }
    .badge { color:#000; }
  </style>

 <style>
    /* Base del “papel” del ticket/comanda (modo pantalla) */
    .print-sheet{
      display:none;
      width:58mm;
      padding:8px 6px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      color:#000;
    }
    .print-sheet hr{ border:0; border-top:1px dashed #000; margin:6px 0; }
    .print-sheet .row{ display:flex; justify-content:space-between; gap:8px; }
    .print-sheet .title{ text-align:center; font-weight:700; font-size:16px; }
    .print-sheet .muted{ font-size:13px; text-align:center; }

    /* SOLO impresión */
    @media print {
      @page { size: 58mm auto; margin: 0; }
      html, body { margin:0; padding:0; width:58mm; }

      /* Esconde TODO por defecto */
      body * { visibility: hidden !important; }

      /* Solo el target activo se ve e imprime */
      .print-active, .print-active * { visibility: visible !important; }
      .print-active{
        display:block !important;
        position:absolute; left:0; top:0;
        width:58mm; box-sizing: border-box;
        font-size:14px; line-height:1.25;
      }
    }
  </style>

  <!-- Config global (UNA sola vez) -->
   <script>
    const STORE_KEY = "elforastero";
    // URL del CSV publicada (separado por coma)
    const MENU_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTOBjJjm_oZvSOYiLN_laVNhv9iJ6wr7w2MgPNPBf7gnP153X6LART0NtA2OcPdtg/pub?gid=1904567791&single=true&output=csv";

    // WebApp exclusivo de EL FORASTERO (reemplazá por tu URL)
    const ORDERS_WEBAPP_URL = "https://script.google.com/macros/s/AKfycby0yh448iFlkae5RGSMSTN_QEtMBQMFo4KqvdBdm_m2AqsYabvYmGYdUa7jrqFvwfx0/exec";
    const STORE_NAME = "El Forastero";
  </script>
</head>
<body class="bg-slate-50  text-black dark:text-black">

  <!-- Sidebar -->
  <aside class="hidden md:flex md:flex-col fixed inset-y-0 left-0 w-64 bg-white border-r border-slate-200">
    <div class="px-5 pt-6 pb-4 flex items-center gap-3">
      <div class="h-9 w-9 grid place-items-center rounded-xl bg-[var(--accent-600)] text-white font-black">EF</div>
      <div>
        <div class="text-lg font-extrabold">El Forastero</div>
        <div class="text-xs text-slate-500">POS & Reportes</div>
      </div>
    </div>
    <nav class="mt-2 px-2 space-y-1">
      <a href="./index.html" class="navlink active">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M3 12l2-2 7-7 7 7-2 2v8a1 1 0 0 1-1 1h-3m-6 0h6"/></svg>
        <span>POS</span>
      </a>
      <a href="./reporte.html" class="navlink">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M3 7h6a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V7z"/><path d="M11 11h4a2 2 0 0 1 2 2v6"/></svg>
        <span>Reporte</span>
      </a>
    </nav>
    <div class="mt-auto p-3">
      <button id="btnLogout" class="btn w-full">Salir</button>
      <div class="text-[10px] text-slate-400 mt-2 text-center">© 2025 El Forastero</div>
    </div>
  </aside>

  <!-- Topbar (mobile) -->
  <header class="md:ml-64 sticky top-0 z-40 bg-white border-b border-slate-200">
    <div class="px-4 py-3 flex items-center justify-between md:justify-end">
      <div class="md:hidden flex items-center gap-3">
        <div class="h-8 w-8 grid place-items-center rounded-lg bg-[var(--accent-600)] text-white font-black">EF</div>
        <span class="font-bold">El Forastero</span>
      </div>
      <div class="text-sm text-slate-500">POS</div>
    </div>
  </header>

  <!-- Contenido principal -->
  <main class="md:ml-64 p-4 sm:p-6">
    <div class="max-w-7xl mx-auto space-y-6">

      <!-- Header POS -->
      <div class="card p-6 flex items-center justify-between">
        <div>
          <h1 class="text-2xl sm:text-3xl font-extrabold tracking-tight">POS El Forastero</h1>
          <p class="text-sm text-gray-500">Multi-carritos · Google Sheets</p>
        </div>
        <div class="text-right">
          <div id="statusBadge" class="badge">Sincronizando…</div>
        </div>
      </div>

      <!-- GRID POS -->
      <div class="container-grid">
        <!-- SIDEBAR Mesas -->
        <aside class="lg:col-span-3 col-span-12 card p-4 h-fit lg:sticky lg:top-6">
          <div class="flex items-center justify-between mb-3">
            <h2 class="text-lg font-semibold">Mesas / Carritos</h2>
            <button id="btnNuevaMesa" class="btn-primary text-sm rounded-xl p-2">+ Nueva</button>
          </div>

          <div id="listaMesas" class="space-y-2"></div>

          <div class="mt-4 p-3 rounded-xl bg-slate-50">
            <label class="block text-xs text-gray-500 mb-1">Color de la mesa seleccionada</label>
            <input id="colorMesa" type="color" class="w-full h-10 rounded cursor-pointer" />
          </div>

          <div class="mt-4 p-3 rounded-xl bg-slate-50">
            <label class="block text-xs text-gray-500 mb-1">Alerta stock (mínimo global)</label>
            <div class="flex items-center gap-2">
              <input id="stockMinGlobal" type="number" min="0" value="3" class="inp w-24" />
              <span class="text-xs text-gray-500">*Si un producto no trae su propio mínimo</span>
            </div>
          </div>

          <p class="text-xs text-gray-500 mt-4">Consejo: duplicá una mesa para armar pedidos similares y acelerar la carga.</p>
        </aside>

        <!-- MAIN POS -->
        <section class="lg:col-span-9 col-span-12 space-y-6">
          <!-- Filtros -->
          <section class="grid grid-cols-1 lg:grid-cols-3 gap-4">
            <div class="card p-4">
              <label class="block text-sm font-medium mb-1" for="categoria">Categoría</label>
              <select id="categoria" class="inp w-full">
                <option value="">Todas</option>
              </select>
            </div>
            <div class="card p-4">
              <label class="block text-sm font-medium mb-1" for="subcategoria">Subcategoría</label>
              <select id="subcategoria" class="inp w-full">
                <option value="">Todas</option>
              </select>
            </div>
            <div class="card p-4">
              <label class="block text-sm font-medium mb-1" for="cliente">Nombre del cliente</label>
              <input id="cliente" type="text" placeholder="Ej: Juan Pérez" class="inp w-full" />
            </div>
          </section>

          <!-- Productos & Carrito -->
          <section class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- Productos -->
            <div class="card overflow-hidden">
              <div class="p-4 border-b flex items-center gap-3">
                <input id="buscar" type="text" placeholder="Buscar producto…" class="inp flex-1" />
                <span class="text-sm text-gray-500">Productos: <b id="countProductos">0</b></span>
              </div>
              <div class="divide-y max-h-[520px] overflow-auto" id="listaProductos"></div>
            </div>

            <!-- Carrito -->
            <div id="cartWrapper" class="card overflow-hidden border-2" style="border-color:#e5e7eb">
              <div class="p-4 border-b flex items-center justify-between">
                <h2 class="text-xl font-semibold"><span id="mesaTitulo">Mesa 1</span></h2>
                <div class="flex gap-2 items-center">
                  <button id="btnDuplicarMesa" class="btn btn-ghost text-sm rounded-xl">Duplicar</button>
                  <button id="btnVaciar" class="btn btn-ghost text-sm rounded-xl">Vaciar</button>
                </div>
              </div>
              <div class="p-4">
                <div id="cartTable" class="w-full text-sm"></div>
                <hr class="my-4" />
                <div class="grid grid-cols-2 gap-4 text-sm">
                  <div class="space-y-2">
                    <div class="flex items-center justify-between"><span>Total bruto</span><span id="totalBruto" class="font-semibold">$0</span></div>
                    <div class="flex items-center justify-between"><span>Costo</span><span id="totalCosto" class="font-semibold">$0</span></div>
                    <div class="flex items-center justify-between"><span>Ganancia</span><span id="totalGanancia" class="font-semibold">$0</span></div>
                  </div>
                  <div class="space-y-2">
                    <label class="block text-sm" for="pago">Pago ($)</label>
                    <input id="pago" type="number" min="0" class="inp w-full"/>
                    <div class="flex items-center justify-between"><span>Vuelto</span><span id="vuelto" class="font-semibold">$0</span></div>
                  </div>
                </div>
              </div>
              <div class="p-4 border-t flex flex-col sm:flex-row gap-3 sm:gap-4">
                <button id="btnGuardar" class="no-print flex-1 btn-primary rounded-2xl py-3 font-semibold">Guardar Pedido</button>
                <button id="btnTicket"  class="no-print flex-1 btn-primary rounded-2xl py-3 font-semibold">Imprimir Ticket</button>
                <button id="btnComanda" class="no-print flex-1 btn-primary rounded-2xl py-3 font-semibold">Imprimir Comanda</button>
              </div>
            </div>
          </section>

          <!-- Hojas de impresión -->
          <!-- Ticket Cliente -->
          <section id="ticketCliente" class="print-sheet">
            <div class="title" id="tck-store">El Forastero</div>
            <div class="muted" id="tck-meta">--</div>
            <hr>
            <div id="tck-items"></div>
            <hr>
            <div class="row"><span>Total</span><span id="tck-total">$0</span></div>
            <div class="row"><span>Pago</span><span id="tck-pago">$0</span></div>
            <div class="row"><span>Vuelto</span><span id="tck-vuelto">$0</span></div>
            <div class="muted" style="margin-top:6px">¡Gracias por su compra!</div>
          </section>

          <!-- Comanda Cocina -->
          <section id="comandaCocina" class="print-sheet">
            <div class="title" id="cmd-store">El Forastero — COMANDA</div>
            <div class="muted" id="cmd-meta">--</div>
            <hr>
            <div id="cmd-items"></div>
            <hr>
            <div class="muted">Preparar y despachar</div>
          </section>

        </section>
      </div>
    </div>
  </main>

  <!-- Librerías -->
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <!-- App POS -->
<script>
  // ===== Menú / productos =====
  let MENU = [];
  const ALERTED = new Set();

  // ===== Multi-Carritos =====
  let MESAS = [];
  let MESA_ACTUAL = null;

  // ===== Utils =====
  const $fmt = (n) => new Intl.NumberFormat('es-AR', { style: 'currency', currency: 'ARS', maximumFractionDigits: 0 }).format(Number(n||0));
  const uid = () => 'm' + Math.random().toString(36).slice(2,9);

  // --- Storage ---
  function loadState(){
    try{
      const raw = localStorage.getItem('pos-1112-mesas');
      if(raw){ const data = JSON.parse(raw); MESAS = data.mesas||[]; MESA_ACTUAL = data.actual||null; }
    }catch{}
    if(MESAS.length===0){
      const id = uid();
      MESAS=[{id, nombre:'Mesa 1', color:'#fb8c00', items:[], cliente:'', pago:0}];
      MESA_ACTUAL=id;
    }
  }
  function saveState(){ localStorage.setItem('pos-1112-mesas', JSON.stringify({mesas:MESAS, actual:MESA_ACTUAL})); }
  function mesaActual(){ return MESAS.find(m=>m.id===MESA_ACTUAL); }

  // ====== STOCK ======
  function reservedQtyAllMesas(rowId){
    return MESAS.reduce((acc,m)=> acc + (m.items||[]).filter(x=>x._rowId===rowId).reduce((a,i)=>a+i.qty,0), 0);
  }
  function productThreshold(p){
    const glob = Number($('#stockMinGlobal').val()||0);
    const own = Number(p.min||p.minimo||p.alerta||0);
    return Number.isFinite(own) && own>0 ? own : glob;
  }
  function availableStock(p){
    const stock = Number(p.stock||0);
    if(!Number.isFinite(stock)) return 0;
    const reserved = reservedQtyAllMesas(p._rowId);
    return Math.max(0, stock - reserved);
  }
  function shouldLowStock(p){
    const min = productThreshold(p);
    return availableStock(p) <= min && (Number(p.stock||0) > 0);
  }
  function shouldNoStock(p){
    return availableStock(p) <= 0 && (Number(p.stock||0) > 0);
  }
  function maybeAlertLow(p){
    if(!shouldLowStock(p)) return;
    const key = p._rowId;
    if(ALERTED.has(key)) return;
    ALERTED.add(key);
    alert(`⚠️ Stock bajo de "${p.nombre}". Quedan ${availableStock(p)} (umbral ${productThreshold(p)}).`);
  }

  // --- Sidebar render ---
  function renderMesas(){
    const cont = $('#listaMesas');
    cont.empty();
    MESAS.forEach(m=>{
      const active = m.id===MESA_ACTUAL;
      cont.append(`
        <div class="group flex items-center justify-between gap-2 p-2 rounded-xl border ${active?'border-[var(--accent-600)] bg-[var(--accent-50)]':'border-gray-200 hover:bg-gray-50'}">
          <button class="flex items-center gap-2 flex-1 text-left" data-action="switch" data-id="${m.id}">
            <span class="inline-block w-3 h-3 rounded-full" style="background:${m.color}"></span>
            <span class="font-medium truncate">${m.nombre}</span>
            <span class="text-xs text-gray-500 ml-auto">${m.items.reduce((a,x)=>a+x.qty,0)} ítems</span>
          </button>
          <div class="opacity-0 group-hover:opacity-100 transition flex gap-1">
            <button class="btn btn-ghost text-xs px-2 py-1" title="Renombrar" data-action="rename" data-id="${m.id}">✎</button>
            <button class="btn btn-ghost text-xs px-2 py-1" title="Duplicar" data-action="dup" data-id="${m.id}">⧉</button>
            <button class="btn btn-ghost text-xs px-2 py-1" title="Eliminar" data-action="del" data-id="${m.id}">✕</button>
          </div>
        </div>`);
    });
    const m = mesaActual();
    $('#mesaTitulo').text(m.nombre);
    $('#cliente').val(m.cliente);
    $('#pago').val(m.pago);
    $('#colorMesa').val(m.color);
    $('#cartWrapper').css('border-color', m.color);
    renderCart();
    saveState();
  }

  function nuevaMesa(nombre='Mesa '+(MESAS.length+1), color='var(--accent-600)'){
    const m = { id:uid(), nombre, color:'#fb8c00', items:[], cliente:'', pago:0 };
    MESAS.push(m); MESA_ACTUAL=m.id; renderMesas();
  }
  function duplicarMesa(id){
    const src = MESAS.find(m=>m.id===id); if(!src) return;
    const copy = { ...src, id:uid(), nombre: src.nombre+" (copia)", items: JSON.parse(JSON.stringify(src.items)) };
    MESAS.push(copy); MESA_ACTUAL=copy.id; renderMesas();
  }
  function eliminarMesa(id){
    if(MESAS.length===1){ alert('Debe quedar al menos una mesa.'); return; }
    MESAS = MESAS.filter(m=>m.id!==id);
    if(MESA_ACTUAL===id){ MESA_ACTUAL = MESAS[0].id; }
    renderMesas();
  }
  function cambiarColorActual(color){ const m=mesaActual(); if(!m) return; m.color=color; $('#cartWrapper').css('border-color', color); saveState(); renderMesas(); }

  // ===== Productos y filtros =====
  function groupUnique(arr, key){ return [...new Set(arr.map(x => (x[key]||"").trim()).filter(Boolean))].sort((a,b)=>a.localeCompare(b)); }
  function renderFilters(){
    const cats = groupUnique(MENU, 'categoria');
    const catSel = $('#categoria');
    catSel.find('option:not(:first)').remove();
    cats.forEach(c => catSel.append(`<option value="${c}">${c}</option>`));
    renderSubcats();
  }
  function renderSubcats(){
    const cat = $('#categoria').val();
    let list = MENU; if(cat) list = MENU.filter(x => x.categoria === cat);
    const subs = groupUnique(list, 'subcategoria');
    const subSel = $('#subcategoria');
    subSel.find('option:not(:first)').remove();
    subs.forEach(s => subSel.append(`<option value="${s}">${s}</option>`));
  }
  function productMatches(p){
    const q=$('#buscar').val().trim().toLowerCase(); const cat=$('#categoria').val(); const sub=$('#subcategoria').val();
    if(cat && p.categoria!==cat) return false; if(sub && p.subcategoria!==sub) return false; if(!q) return true;
    return [p.nombre,p.categoria,p.subcategoria].join(' ').toLowerCase().includes(q);
  }

  function renderProducts(){
    const cont=$('#listaProductos'); cont.empty();
    const list=MENU.filter(productMatches);
    $('#countProductos').text(list.length);

    list.forEach(p=>{
      const dispStock = Number.isFinite(Number(p.stock)) ? availableStock(p) : null;
      const isLow  = dispStock!==null && shouldLowStock(p);
      const isZero = dispStock!==null && shouldNoStock(p);

      const rowClasses = `${isLow?'low-stock':''} ${isZero?'no-stock':''}`;
      const stockHtml = (dispStock!==null)
        ? `<span class='text-xs ${isLow?'text-red-700':'text-gray-500'}'>Stock disp.: ${dispStock}${isLow?` · min ${productThreshold(p)}`:''}</span>`
        : `<span class='text-xs text-gray-400'>Sin stock informado</span>`;

      cont.append(`
        <div class="p-3 flex items-center gap-3 hover:bg-gray-50 ${rowClasses}">
          <div class="flex-1">
            <div class="font-medium title">${p.nombre}</div>
            <div class="text-xs text-gray-500">${p.categoria}${p.subcategoria?" · "+p.subcategoria:""}</div>
            ${stockHtml}
          </div>
          <div class="text-right">
            <div class="text-base font-semibold">${$fmt(p.precio)}</div>
            ${p.costo?`<div class="text-[11px] text-gray-500">Costo ${$fmt(p.costo)}</div>`:""}
          </div>
          <div>
            <button ${isZero?'disabled':''} class="p-2 text-sm rounded-xl ${isZero?'btn cursor-not-allowed opacity-60':'btn-primary'}" data-id="${p._rowId}" data-action="add">Agregar</button>
          </div>
        </div>`);
    });
  }

  // ===== Carrito (por mesa) =====
  function addToCart(rowId){
    const m=mesaActual(); const p=MENU.find(x=>x._rowId===rowId); if(!m||!p) return;

    if(Number.isFinite(Number(p.stock))){
      const disp = availableStock(p);
      if(disp<=0){ alert(`Sin stock de "${p.nombre}"`); renderProducts(); return; }
    }

    const ex=m.items.find(x=>x._rowId===rowId);
    if(ex){
      if(Number.isFinite(Number(p.stock))){
        const disp = availableStock(p);
        if(disp<=0){ alert(`Sin stock de "${p.nombre}"`); renderProducts(); return; }
      }
      ex.qty+=1;
    }else{
      m.items.push({_rowId:rowId,nombre:p.nombre,precio:Number(p.precio)||0,costo:Number(p.costo)||0,qty:1});
    }
    maybeAlertLow(p);
    renderCart(); saveState(); renderProducts();
  }

  function removeFromCart(rowId){
    const m=mesaActual(); if(!m) return;
    m.items = m.items.filter(x=>x._rowId!==rowId);
    renderCart(); saveState(); renderProducts();
  }

  function setQty(rowId,qty){
    const m=mesaActual(); if(!m) return;
    const it=m.items.find(x=>x._rowId===rowId); if(!it) return;
    qty = Math.max(1,Number(qty)||1);

    const p=MENU.find(x=>x._rowId===rowId);
    if(Number.isFinite(Number(p?.stock))){
      const reservedOtros = reservedQtyAllMesas(rowId) - it.qty;
      const disp = Math.max(0, Number(p.stock||0) - reservedOtros);
      if(qty > disp){
        alert(`Solo hay ${disp} disponibles de "${p.nombre}".`);
        qty = disp>0 ? disp : 1;
      }
    }
    it.qty = qty;
    maybeAlertLow(p);
    renderCart(); saveState(); renderProducts();
  }

  function renderCart(){
    const m=mesaActual(); const cont=$('#cartTable'); cont.empty(); if(!m){return}
    const CART=m.items;
    if(CART.length===0){ cont.html('<p class="text-sm text-gray-500">No hay ítems en el carrito.</p>'); }
    else{
      CART.forEach(it=>{
        const linea=it.precio*it.qty;
        cont.append(`
        <div class="grid grid-cols-12 gap-2 items-center py-2">
          <div class="col-span-5">
            <div class="font-medium">${it.nombre}</div>
            <div class="text-xs text-gray-500">${$fmt(it.precio)} c/u</div>
          </div>
          <div class="col-span-3">
            <input type="number" min="1" value="${it.qty}" data-id="${it._rowId}" data-action="qty" class="inp w-24"/>
          </div>
          <div class="col-span-3 text-right font-semibold">${$fmt(linea)}</div>
          <div class="col-span-1 text-right">
            <button class="btn btn-ghost text-xs px-2 py-1" data-id="${it._rowId}" data-action="del">✕</button>
          </div>
        </div>`);
      });
    }

    const total = CART.reduce((a,x)=>a+x.precio*x.qty,0);
    const costo = CART.reduce((a,x)=>a+(Number(x.costo)||0)*x.qty,0);
    $('#totalBruto').text($fmt(total)); $('#totalCosto').text($fmt(costo)); $('#totalGanancia').text($fmt(total-costo));
    const pago = Number($('#pago').val()||m.pago||0); const vuelto = Math.max(0, pago-total); $('#vuelto').text($fmt(vuelto));
  }

  async function saveOrder(){
    const m=mesaActual(); if(!m) return;
    if(!ORDERS_WEBAPP_URL || ORDERS_WEBAPP_URL.startsWith('PASTE_')){ alert('Configura ORDERS_WEBAPP_URL'); return; }
    if(m.items.length===0){ alert('El carrito está vacío.'); return; }

    for(const it of m.items){
      const p = MENU.find(x=>x._rowId===it._rowId);
      if(Number.isFinite(Number(p?.stock))){
        const disp = availableStock(p);
        if(it.qty > disp){
          alert(`No hay stock suficiente de "${p.nombre}". Disponible: ${disp}.`);
          return;
        }
      }
    }

    const total = m.items.reduce((a,x)=>a+x.precio*x.qty,0);
    const totalCosto = m.items.reduce((a,x)=>a+(Number(x.costo)||0)*x.qty,0);
    const payload = {
      timestamp:new Date().toISOString(),
      cliente:m.cliente||'',
      mesa:m.nombre,
      color:m.color,
      total, totalCosto,
      ganancia: total-totalCosto,
      pago: Number(m.pago||0),
      items: m.items.map(x=>({nombre:x.nombre,precio:x.precio,costo:x.costo,qty:x.qty}))
    };

    $('#btnGuardar').prop('disabled',true).text('Guardando…');
    try{
      const res = await fetch(ORDERS_WEBAPP_URL, {
        method:'POST',
        headers:{'Content-Type':'application/x-www-form-urlencoded;charset=UTF-8'},
        body:'payload='+encodeURIComponent(JSON.stringify(payload))
      });
      const txt = await res.text(); let data; try{ data=JSON.parse(txt) }catch{ data={ok:true} }
      if(!res.ok || data.ok===false) throw new Error((data && data.error) || 'Error al guardar');

      for(const it of m.items){
        const p = MENU.find(x=>x._rowId===it._rowId);
        if(p && Number.isFinite(Number(p.stock))){
          p.stock = Math.max(0, Number(p.stock) - it.qty);
        }
      }

      alert('Pedido guardado ✅');
      m.items=[]; renderCart(); saveState(); renderProducts();
    }catch(err){
      console.error(err);
      alert('No se pudo guardar el pedido: '+err.message);
    }finally{
      $('#btnGuardar').prop('disabled',false).text('Guardar Pedido');
    }
  }

  // ==== Construcción de hojas y disparo de impresión ====
  function buildTicketCliente(m){
    const meta = `${new Date().toLocaleString('es-AR')} · ${m.nombre} · Cliente: ${m.cliente||'-'}`;
    const store = (typeof STORE_NAME!=='undefined' && STORE_NAME) ? STORE_NAME : 'El Forastero';
    const elStore = document.getElementById('tck-store');
    const elMeta  = document.getElementById('tck-meta');
    const cont    = document.getElementById('tck-items');
    const elTot   = document.getElementById('tck-total');
    const elPago  = document.getElementById('tck-pago');
    const elVuel  = document.getElementById('tck-vuelto');

    if(elStore) elStore.textContent = store;
    if(elMeta)  elMeta.textContent  = meta;
    if(cont){
      cont.innerHTML='';
      m.items.forEach(x=>{
        const row=document.createElement('div'); row.className='row';
        row.innerHTML=`<span>${x.qty}× ${x.nombre}</span><span>${$fmt(x.qty*x.precio)}</span>`;
        cont.appendChild(row);
      });
    }
    const total = m.items.reduce((a,x)=>a + x.precio*x.qty, 0);
    const pago  = Number(m.pago||0);
    const vuelto= Math.max(0, pago-total);
    if(elTot)  elTot.textContent  = $fmt(total);
    if(elPago) elPago.textContent  = $fmt(pago);
    if(elVuel) elVuel.textContent  = $fmt(vuelto);
  }

  function buildComandaCocina(m){
    const meta = `${new Date().toLocaleString('es-AR')} · ${m.nombre} · Cliente: ${m.cliente||'-'}`;
    const store = (typeof STORE_NAME!=='undefined' && STORE_NAME) ? STORE_NAME : 'El Forastero';
    const elStore = document.getElementById('cmd-store');
    const elMeta  = document.getElementById('cmd-meta');
    const cont    = document.getElementById('cmd-items');

    if(elStore) elStore.textContent = store + ' — COMANDA';
    if(elMeta)  elMeta.textContent  = meta;
    if(cont){
      cont.innerHTML='';
      m.items.forEach(x=>{
        const row=document.createElement('div');
        row.style.display='flex'; row.style.justifyContent='space-between'; row.style.gap='8px';
        row.innerHTML = `<span>${x.qty}× ${x.nombre}</span><span>${x.notas ? x.notas : ''}</span>`;
        cont.appendChild(row);
      });
    }
  }

  // NUEVO: solo imprime la sección marcada como activa
  function printSection(sectionId){
    const a = document.getElementById('ticketCliente');
    const b = document.getElementById('comandaCocina');
    if(a) a.classList.remove('print-active');
    if(b) b.classList.remove('print-active');

    const target = document.getElementById(sectionId);
    if(target) target.classList.add('print-active');

    window.print();

    // Limpia marca de impresión
    setTimeout(()=>{ if(target) target.classList.remove('print-active'); }, 250);
  }

  function printTicketCliente(){
    const m=mesaActual(); if(!m || (m.items||[]).length===0){ alert('No hay items.'); return; }
    buildTicketCliente(m);
    printSection('ticketCliente');
  }
  function printComandaCocina(){
    const m=mesaActual(); if(!m || (m.items||[]).length===0){ alert('No hay items.'); return; }
    buildComandaCocina(m);
    printSection('comandaCocina');
  }

  // ===== Eventos UI =====
  function bindEvents(){
    $('#btnNuevaMesa').on('click', ()=> nuevaMesa());
    $('#listaMesas').on('click','[data-action="switch"]', function(){ MESA_ACTUAL=$(this).data('id'); renderMesas(); });
    $('#listaMesas').on('click','[data-action="rename"]', function(){ const id=$(this).data('id'); const m=MESAS.find(x=>x.id===id); if(!m) return; const nv = prompt('Nuevo nombre', m.nombre); if(nv){ m.nombre=nv; if(MESA_ACTUAL===id) $('#mesaTitulo').text(nv); renderMesas(); } });
    $('#listaMesas').on('click','[data-action="dup"]', function(){ duplicarMesa($(this).data('id')); });
    $('#listaMesas').on('click','[data-action="del"]', function(){ eliminarMesa($(this).data('id')); });
    $('#colorMesa').on('input', function(){ cambiarColorActual($(this).val()); });

    $('#stockMinGlobal').on('input', ()=> renderProducts());

    $('#categoria').on('change', function(){ renderSubcats(); renderProducts(); });
    $('#subcategoria, #buscar').on('input change', renderProducts);

    $('#listaProductos').on('click','button[data-action="add"]', function(){ addToCart($(this).data('id')); });

    $('#cartTable').on('click','button[data-action="del"]', function(){ removeFromCart($(this).data('id')); });
    $('#cartTable').on('input','input[data-action="qty"]', function(){ setQty($(this).data('id'), $(this).val()); });

    $('#cliente').on('input', function(){ const m=mesaActual(); if(!m) return; m.cliente=$(this).val(); saveState(); });
    $('#pago').on('input', function(){ const m=mesaActual(); if(!m) return; m.pago=Number($(this).val()||0); renderCart(); saveState(); });

    $('#btnVaciar').on('click', function(){ const m=mesaActual(); if(!m) return; m.items=[]; renderCart(); saveState(); renderProducts(); });
    $('#btnDuplicarMesa').on('click', function(){ duplicarMesa(MESA_ACTUAL); });
    $('#btnGuardar').on('click', saveOrder);

    // Botones de impresión
    $('#btnTicket').on('click', printTicketCliente);
    $('#btnComanda').on('click', printComandaCocina);
  }

  // ===== Carga de menú =====
  function normalizeRow(row, idx){
    const min = row.min ?? row.minimo ?? row.alerta ?? row.Min ?? row.Mínimo ?? row.Alerta;
    const stock = row.stock ?? row.Stock ?? row.inventario ?? row.existencias;
    return {
      _rowId:`r${idx}`,
      categoria:(row.categoria||row.Categoria||row.categoría||row.Categoría||'').toString().trim(),
      subcategoria:(row.subcategoria||row.Subcategoria||row.Subcategoría||row['Sub-categoria']||'').toString().trim(),
      nombre:(row.nombre||row.producto||row.Producto||row.Nombre||'').toString().trim(),
      precio:Number(row.precio||row.Precio||row.price||0),
      costo:Number(row.costo||row.Costo||row.cost||0),
      stock: stock===''||stock==null ? '' : Number(stock),
      min:   min===''||min==null   ? '' : Number(min)
    };
  }

  async function loadMenu(){
    if(!MENU_CSV_URL || MENU_CSV_URL.startsWith('PASTE_')){
      $('#statusBadge').attr('class','badge').text('Configura MENU_CSV_URL'); return;
    }
    $('#statusBadge').attr('class','badge').text('Cargando menú…');
    return new Promise((resolve)=>{
      Papa.parse(MENU_CSV_URL,{
        download:true, header:true,
        complete:(results)=>{
          MENU = results.data
            .filter(r=>r && Object.keys(r).length)
            .map(normalizeRow)
            .filter(x=>x.nombre && !isNaN(x.precio));
          ALERTED.clear();
          renderFilters(); renderProducts(); renderCart();
          $('#statusBadge').attr('class','badge').text('Menú sincronizado');
          resolve();
        },
        error:()=>{
          $('#statusBadge').attr('class','badge').text('Error al cargar menú');
          resolve();
        }
      });
    });
  }

  // ===== Init =====
  $(async function(){ loadState(); bindEvents(); renderMesas(); await loadMenu(); });
</script>


<script>
  function printSectionInPopup(sectionId){
    const src = document.getElementById(sectionId);
    if(!src){ alert('No se encontró la sección a imprimir'); return; }

    const w = window.open('', 'print58',
      'width=270,height=900,menubar=0,toolbar=0,location=0,status=0,scrollbars=0');
    if(!w){ alert('El navegador bloqueó la ventana de impresión'); return; }

    const css = `
      <style>
        @page { size: 58mm auto; margin: 0; }
        html,body{ margin:0; padding:0; width:58mm; }
        .sheet{ width:58mm; box-sizing:border-box; padding:8px 6px;
                font-family: ui-monospace, monospace;
                color:#000; font-size:12px; line-height:1.25; }
        .sheet hr{ border:0; border-top:1px dashed #000; margin:6px 0; }
        .row{ display:flex; justify-content:space-between; gap:8px; }
        .title{ text-align:center; font-weight:700; font-size:14px; }
        .muted{ font-size:10px; text-align:center; }
      </style>
    `;

    w.document.open();
    w.document.write(`<!doctype html><html><head><meta charset="utf-8">${css}</head><body></body></html>`);
    w.document.close();

    const wrap = w.document.createElement('div');
    wrap.className = 'sheet';
    wrap.innerHTML = src.innerHTML;
    w.document.body.appendChild(wrap);

    setTimeout(() => {
      w.focus();
      w.print();
      setTimeout(() => { try { w.close(); } catch(_){} }, 300);
    }, 50);
  }

  function printTicketCliente(){
    const m = mesaActual();
    if(!m || (m.items||[]).length===0){ alert('No hay items.'); return; }
    buildTicketCliente(m);
    printSectionInPopup('ticketCliente');
  }

  function printComandaCocina(){
    const m = mesaActual();
    if(!m || (m.items||[]).length===0){ alert('No hay items.'); return; }
    buildComandaCocina(m);
    printSectionInPopup('comandaCocina');
  }
</script>

</body>
</html>

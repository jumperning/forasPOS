<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>POS â€” El Forastero</title>
  <link rel="icon" href="data:;base64,iVBORw0KGgo=" />
  <script> window.tailwind = { config: { darkMode: 'class' } } </script>
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    :root{
      --surface:#ffffff; --surface-weak:#f6f7f9;
      --accent-50:#fff1f2; --accent-100:#ffe4e6;
      --accent-500:#f43f5e; --accent-600:#fb8c00;
    }
    html,body{height:100%}
    .container-grid{display:grid;grid-template-columns:repeat(12,minmax(0,1fr));gap:1rem}
    @media (min-width:1024px){ .container-grid{gap:1rem} }
    .card{ background:var(--surface); border-radius:1rem; border:1px solid rgba(15,23,42,.08); }
    .btn{ padding:.5rem .875rem; border-radius:.75rem; border:1px solid rgba(15,23,42,.10); background:#fff; }
    .btn:hover{ background:#f9fafb }
    .btn-primary{ border:none; background:var(--accent-600); color:#fff }
    .btn-primary:hover{ background:var(--accent-500) }
    .btn-ghost{ border-color:rgba(15,23,42,.10); background:#fff }
    .btn-ghost:hover{ background:#f9fafb }
    .inp{ border-radius:.75rem; border:1px solid #e5e7eb; padding:.5rem .75rem }
    .inp:focus{ outline:none; box-shadow:0 0 0 3px rgba(244,63,94,.15),0 0 0 1px var(--accent-500); border-color:var(--accent-500) }
    .badge{ display:inline-flex; align-items:center; gap:.375rem; padding:.25rem .5rem; border-radius:999px; font-size:.75rem; color:#000; background:#f3f4f6; }
    body { color:#000; }
    .text-slate-800,.text-slate-700,.text-slate-600,.text-slate-500,.text-slate-400,
    .text-gray-800,.text-gray-700,.text-gray-600,.text-gray-500,.text-gray-400 { color:#000 !important; }
  </style>

  <style>
    .print-sheet{
      display:none;
      width:58mm;
      padding:8px 6px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      color:#000;
    }
    .print-sheet hr{ border:0; border-top:1px dashed #000; margin:6px 0; }
    .print-sheet .row{ display:flex; justify-content:space-between; gap:8px; }
    .print-sheet .title{ text-align:center; font-weight:700; font-size:16px; }
    .print-sheet .muted{ font-size:13px; text-align:center; }
    @media print {
      @page { size: 58mm auto; margin: 0; }
      html, body { margin:0; padding:0; width:58mm; }
      body * { visibility: hidden !important; }
      .print-active, .print-active * { visibility: visible !important; }
      .print-active{ display:block !important; position:absolute; left:0; top:0; width:58mm; box-sizing: border-box; font-size:14px; line-height:1.25; }
    }
  </style>

  <!-- Config global -->
  <script>
    const STORE_KEY = "elforastero";
    const STORE_NAME = "El Forastero";
    const ORDERS_WEBAPP_URL = '/.netlify/functions/gs-order'; // guardar pedidos
    const API = '/.netlify/functions/gs-order';               // menu, setStock, etc
  </script>
</head>
<body class="bg-slate-50 text-black">

  <main class="md:ml-0 p-4 sm:p-6">
    <div class="max-w-8xl mx-auto space-y-6">
      <div class="card p-6 flex items-center justify-between">
        <div>
          <h1 class="text-2xl sm:text-3xl font-extrabold tracking-tight">POS El Forastero</h1>
          <p class="text-sm text-gray-500">Multi-carritos Â· Google Sheets</p>
        </div>
        <div class="text-right">
          <div id="statusBadge" class="badge">Sincronizandoâ€¦</div>
        </div>
      </div>

      <div class="container-grid">
        <aside class="lg:col-span-3 col-span-12 card p-4 h-fit lg:sticky lg:top-6">
          <div class="flex items-center justify-between mb-3">
            <h2 class="text-lg font-semibold">Mesas / Carritos</h2>
            <button id="btnNuevaMesa" class="btn-primary text-sm rounded-xl p-2">+ Nueva</button>
          </div>
          <div id="listaMesas" class="space-y-2"></div>

          <div class="mt-4 p-3 rounded-xl bg-slate-50">
            <label class="block text-xs text-gray-500 mb-1">Color de la mesa seleccionada</label>
            <input id="colorMesa" type="color" class="w-full h-10 rounded cursor-pointer" />
          </div>

          <div class="mt-4 p-3 rounded-xl bg-slate-50">
            <label class="block text-xs text-gray-500 mb-1">Alerta stock (mÃ­nimo global)</label>
            <div class="flex items-center gap-2">
              <input id="stockMinGlobal" type="number" min="0" value="3" class="inp w-24" />
              <span class="text-xs text-gray-500">*Si un producto no trae su propio mÃ­nimo</span>
            </div>
          </div>

          <p class="text-xs text-gray-500 mt-4">Consejo: duplicÃ¡ una mesa para armar pedidos similares y acelerar la carga.</p>
        </aside>

        <section class="lg:col-span-9 col-span-12 space-y-6">
          <section class="grid grid-cols-1 lg:grid-cols-3 gap-4">
            <div class="card p-4">
              <label class="block text-sm font-medium mb-1" for="categoria">CategorÃ­a</label>
              <select id="categoria" class="inp w-full">
                <option value="">Todas</option>
              </select>
            </div>
            <div class="card p-4">
              <label class="block text-sm font-medium mb-1" for="subcategoria">SubcategorÃ­a</label>
              <select id="subcategoria" class="inp w-full">
                <option value="">Todas</option>
              </select>
            </div>
            <div class="card p-4">
              <label class="block text-sm font-medium mb-1" for="cliente">Nombre del cliente</label>
              <input id="cliente" type="text" placeholder="Ej: Juan PÃ©rez" class="inp w-full" />
            </div>
          </section>

          <section class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div class="card overflow-hidden">
              <div class="p-4 border-b flex items-center gap-3">
                <input id="buscar" type="text" placeholder="Buscar productoâ€¦" class="inp flex-1" />
                <span class="text-sm text-gray-500">Productos: <b id="countProductos">0</b></span>
              </div>
              <div class="divide-y max-h-[520px] overflow-auto" id="listaProductos"></div>
            </div>

            <div id="cartWrapper" class="card overflow-hidden border-2" style="border-color:#e5e7eb">
              <div class="p-4 border-b flex items-center justify-between">
                <h2 class="text-xl font-semibold"><span id="mesaTitulo">Mesa 1</span></h2>
                <div class="flex gap-2 items-center">
                  <button id="btnDuplicarMesa" class="btn btn-ghost text-sm rounded-xl">Duplicar</button>
                  <button id="btnVaciar" class="btn btn-ghost text-sm rounded-xl">Vaciar</button>
                </div>
              </div>

              <div class="p-4">
                <div id="cartTable" class="w-full text-sm"></div>
                <hr class="my-4" />
                <div class="grid grid-cols-2 gap-4 text-sm">
                  <div class="space-y-2">
                    <div class="flex items-center justify-between"><span>Total bruto</span><span id="totalBruto" class="font-semibold">$0</span></div>
                    <div class="flex items-center justify-between"><span>Costo</span><span id="totalCosto" class="font-semibold">$0</span></div>
                    <div class="flex items-center justify-between"><span>Ganancia</span><span id="totalGanancia" class="font-semibold">$0</span></div>
                  </div>
                  <div class="space-y-2">
                    <label class="block text-sm" for="pago">Pago ($)</label>
                    <input id="pago" type="number" min="0" class="inp w-full"/>
                    <div class="flex items-center justify-between"><span>Vuelto</span><span id="vuelto" class="font-semibold">$0</span></div>
                  </div>
                </div>
              </div>

              <div class="p-4 border-t flex flex-col sm:flex-row gap-3 sm:gap-4">
                <button id="btnGuardar" class="no-print flex-1 btn-primary rounded-2xl py-3 font-semibold">Guardar Pedido</button>
                <button id="btnTicket"  class="no-print flex-1 btn-primary rounded-2xl py-3 font-semibold">Imprimir Ticket</button>
                <button id="btnComanda" class="no-print flex-1 btn-primary rounded-2xl py-3 font-semibold">Imprimir Comanda</button>
              </div>
            </div>
          </section>

          <!-- Ticket cliente -->
          <section id="ticketCliente" class="print-sheet">
            <div class="title" id="tck-store">El Forastero</div>
            <div class="muted" id="tck-meta">--</div>
            <hr>
            <div id="tck-items"></div>
            <hr>
            <div class="row"><span>Total</span><span id="tck-total">$0</span></div>
            <div class="row"><span>Pago</span><span id="tck-pago">$0</span></div>
            <div class="row"><span>Vuelto</span><span id="tck-vuelto">$0</span></div>
            <div class="muted" style="margin-top:6px">Â¡Gracias por su compra!</div>
          </section>

          <!-- Comanda cocina -->
          <section id="comandaCocina" class="print-sheet">
            <div class="title" id="cmd-store">El Forastero â€” COMANDA</div>
            <div class="muted" id="cmd-meta">--</div>
            <hr>
            <div id="cmd-items"></div>
            <hr>
            <div class="muted">Preparar y despachar</div>
          </section>

        </section>
      </div>
    </div>
  </main>

  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

  <script>
  // ---------- Estado & helpers ----------
 let MENU = [];
window.MENU = MENU;
  const ALERTED = new Set();
  let MESAS = [];
  let MESA_ACTUAL = null;

  const $fmt = (n) => new Intl.NumberFormat('es-AR', { style: 'currency', currency: 'ARS', maximumFractionDigits: 0 }).format(Number(n||0));
  const uid = () => 'm' + Math.random().toString(36).slice(2,9);

  function loadState(){
    try{
      const raw = localStorage.getItem('pos-1112-mesas');
      if(raw){ const data = JSON.parse(raw); MESAS = data.mesas||[]; MESA_ACTUAL = data.actual||null; }
    }catch(e){}
    if(MESAS.length===0){
      const id = uid();
      MESAS=[{id, nombre:'Mesa 1', color:'#fb8c00', items:[], cliente:'', pago:0}];
      MESA_ACTUAL=id;
    }
  }
  function saveState(){ localStorage.setItem('pos-1112-mesas', JSON.stringify({mesas:MESAS, actual:MESA_ACTUAL})); }
  function mesaActual(){ return MESAS.find(m=>m.id===MESA_ACTUAL); }

  function reservedQtyAllMesas(rowId){
    return MESAS.reduce((acc,m)=> acc + (m.items||[]).filter(x=>x._rowId===rowId).reduce((a,i)=>a+i.qty,0), 0);
  }
  function productThreshold(p){
    const glob = Number($('#stockMinGlobal').val()||0);
    const own = Number(p.min||p.minimo||p.alerta||0);
    return Number.isFinite(own) && own>0 ? own : glob;
  }

  // controla stock SOLO si stock es un nÃºmero real
  function controlsStock(p){
    return p != null && p.stock !== null && p.stock !== '' && Number.isFinite(Number(p.stock));
  }

  function availableStock(p){
    if (!controlsStock(p)) return Infinity;
    const stock = Number(p.stock);
    const reserved = reservedQtyAllMesas(p._rowId);
    return Math.max(0, stock - reserved);
  }

  function shouldLowStock(p){
    if (!controlsStock(p)) return false;
    const min = productThreshold(p);
    return availableStock(p) <= min && Number(p.stock) > 0;
  }
  function shouldNoStock(p){
    if (!controlsStock(p)) return false;
    return availableStock(p) <= 0 && Number(p.stock) > 0;
  }
  function maybeAlertLow(p){
    if(!shouldLowStock(p)) return;
    const key = p._rowId;
    if(ALERTED.has(key)) return;
    ALERTED.add(key);
    alert(`âš ï¸ Stock bajo de "${p.nombre}". Quedan ${availableStock(p)} (umbral ${productThreshold(p)}).`);
  }

  // ---------- Render ----------
  function groupUnique(arr, key){ return [...new Set(arr.map(x => (x[key]||"").toString().trim()).filter(Boolean))].sort((a,b)=>a.localeCompare(b)); }

  function renderFilters(){
    const cats = groupUnique(MENU, 'categoria');
    const catSel = $('#categoria');
    catSel.find('option:not(:first)').remove();
    cats.forEach(c => catSel.append(`<option value="${c}">${c}</option>`));
    renderSubcats();
  }
  function renderSubcats(){
    const cat = ($('#categoria').val()||'').toString().trim();
    let list = MENU; if(cat) list = MENU.filter(x => (x.categoria||'').toString().trim() === cat);
    const subs = groupUnique(list, 'subcategoria');
    const subSel = $('#subcategoria');
    subSel.find('option:not(:first)').remove();
    subs.forEach(s => subSel.append(`<option value="${s}">${s}</option>`));
  }

  function productMatches(p){
    if (!p) return false;
    const q   = String($('#buscar').val() || '').trim().toLowerCase();
    const cat = String($('#categoria').val() || '').trim();
    const sub = String($('#subcategoria').val() || '').trim();

    const pc = String(p.categoria ?? '').trim();
    const ps = String(p.subcategoria ?? '').trim();

    if (cat && pc !== cat) return false;
    if (sub && ps !== sub) return false;

    if (!q) return true;
    const haystack = [
      p.nombre, p.categoria, p.subcategoria, p.sku, p.tipo, p.subtipo, p.descripcion
    ].filter(Boolean).map(x => String(x).toLowerCase()).join(' ');
    return haystack.includes(q);
  }

 function renderProducts(){
  const cont = $('#listaProductos');
  cont.empty();

  try{
    // ðŸ‘‰ ignoramos filtros por ahora: usamos TODO el menÃº
    let list = Array.isArray(MENU) ? MENU.slice() : [];
    console.log('[renderProducts] MENU len =', Array.isArray(MENU)?MENU.length:'(no array)');

    $('#countProductos').text(list.length);

    list.forEach(p=>{
      const ctrl = controlsStock(p);
      const dispStock = ctrl ? availableStock(p) : null;
      const isLow  = ctrl && shouldLowStock(p);
      const isZero = ctrl && shouldNoStock(p);

      const rowClasses = `${isLow?'low-stock':''} ${isZero?'no-stock':''}`;
      const stockHtml = ctrl
        ? `<span class='text-xs ${isLow?'text-red-700':'text-gray-500'}'>Stock disp.: ${dispStock}${isLow?` Â· min ${productThreshold(p)}`:''}</span>`
        : `<span class='text-xs text-gray-400'>Sin stock informado</span>`;

      cont.append(`
        <div class="p-3 flex items-center gap-3 hover:bg-gray-50 ${rowClasses}">
          <div class="flex-1">
            <div class="font-medium title">${p?.nombre ?? '(sin nombre)'}</div>
            <div class="text-xs text-gray-500">${(p?.categoria||'')}${p?.subcategoria?` Â· ${p.subcategoria}`:''}</div>
            ${stockHtml}
          </div>
          <div class="text-right">
            <div class="text-base font-semibold">${$fmt(p?.precio)}</div>
            ${p?.costo?`<div class="text-[11px] text-gray-500">Costo ${$fmt(p.costo)}</div>`:''}
            ${p?.sku ? `<button class="btn btn-ghost text-[11px] mt-1" data-action="edit-stock" data-sku="${p.sku}">Editar stock</button>` : ''}
          </div>
          <div>
            <button ${isZero?'disabled':''}
              class="p-2 text-sm rounded-xl ${isZero?'btn cursor-not-allowed opacity-60':'btn-primary'}"
              data-id="${String(p?._rowId ?? '')}" data-action="add">Agregar</button>
          </div>
        </div>`);
    });

    if (cont.children().length === 0) {
      console.warn('[renderProducts] No se pintÃ³ nada. Ejemplo primer item:', list[0]);
      cont.html(`<div class="p-4 text-sm text-gray-500">No hay productos para mostrar.</div>`);
    } else {
      console.log('[renderProducts] Pintados:', cont.children().length);
    }
  } catch (err){
    console.error('renderProducts error:', err);
    const list = Array.isArray(MENU) ? MENU : [];
    $('#countProductos').text(list.length);
    cont.append(list.map(p => `
      <div class="p-2 flex items-center justify-between">
        <div>${p?.nombre ?? '(sin nombre)'}</div>
        <button class="btn btn-primary text-sm" data-id="${String(p?._rowId ?? '')}" data-action="add">Agregar</button>
      </div>
    `).join(''));
  }
}

  function renderMesas(){
    const cont = $('#listaMesas');
    cont.empty();
    MESAS.forEach(m=>{
      const active = m.id===MESA_ACTUAL;
      cont.append(`
        <div class="group flex items-center justify-between gap-2 p-2 rounded-xl border ${active?'border-[var(--accent-600)] bg-[var(--accent-50)]':'border-gray-200 hover:bg-gray-50'}">
          <button class="flex items-center gap-2 flex-1 text-left" data-action="switch" data-id="${m.id}">
            <span class="inline-block w-3 h-3 rounded-full" style="background:${m.color}"></span>
            <span class="font-medium truncate">${m.nombre}</span>
            <span class="text-xs text-gray-500 ml-auto">${m.items.reduce((a,x)=>a+x.qty,0)} Ã­tems</span>
          </button>
          <div class="opacity-0 group-hover:opacity-100 transition flex gap-1">
            <button class="btn btn-ghost text-xs px-2 py-1" title="Renombrar" data-action="rename" data-id="${m.id}">âœŽ</button>
            <button class="btn btn-ghost text-xs px-2 py-1" title="Duplicar" data-action="dup" data-id="${m.id}">â§‰</button>
            <button class="btn btn-ghost text-xs px-2 py-1" title="Eliminar" data-action="del" data-id="${m.id}">âœ•</button>
          </div>
        </div>`);
    });
    const m = mesaActual();
    $('#mesaTitulo').text(m.nombre);
    $('#cliente').val(m.cliente);
    $('#pago').val(m.pago);
    $('#colorMesa').val(m.color);
    $('#cartWrapper').css('border-color', m.color);
    renderCart();
    saveState();
  }

  // ---------- Cart ----------
  function addToCart(rowId){
    const m = mesaActual();
    if (!m) return;
    let p = MENU.find(x => x._rowId === rowId);
    if (!p) {
      p = MENU.find(x => String(x.nombre || '').trim() === String(rowId || '').trim());
    }
    if (!p) {
      console.warn('No encontrÃ© el producto para rowId:', rowId);
      alert('No pude identificar el producto en el menÃº.');
      return;
    }

    if(controlsStock(p)){
      const disp = availableStock(p);
      if(disp<=0){ alert(`Sin stock de "${p.nombre}"`); renderProducts(); return; }
    }
    const ex=m.items.find(x=>x._rowId===rowId);
    if(ex){
      if(controlsStock(p)){
        const disp = availableStock(p);
        if(disp<=0){ alert(`Sin stock de "${p.nombre}"`); renderProducts(); return; }
      }
      ex.qty+=1;
    }else{
      m.items.push({_rowId:String(rowId),nombre:p.nombre,precio:Number(p.precio)||0,costo:Number(p.costo)||0,qty:1});
    }
    maybeAlertLow(p);
    renderCart(); saveState(); renderProducts();
  }
  function removeFromCart(rowId){
    const m=mesaActual(); if(!m) return;
    m.items = m.items.filter(x=>x._rowId!==rowId);
    renderCart(); saveState(); renderProducts();
  }
  function setQty(rowId,qty){
    const m=mesaActual(); if(!m) return;
    const it=m.items.find(x=>x._rowId===rowId); if(!it) return;
    qty = Math.max(1,Number(qty)||1);
    const p=MENU.find(x=>x._rowId===rowId);
    if(controlsStock(p)){
      const reservedOtros = reservedQtyAllMesas(rowId) - it.qty;
      const disp = Math.max(0, Number(p.stock||0) - reservedOtros);
      if(qty > disp){
        alert(`Solo hay ${disp} disponibles de "${p.nombre}".`);
        qty = disp>0 ? disp : 1;
      }
    }
    it.qty = qty;
    maybeAlertLow(p);
    renderCart(); saveState(); renderProducts();
  }
  function renderCart(){
    const m=mesaActual(); const cont=$('#cartTable'); cont.empty(); if(!m){return;}
    const CART=m.items;
    if(CART.length===0){ cont.html('<p class="text-sm text-gray-500">No hay Ã­tems en el carrito.</p>'); }
    else{
      CART.forEach(it=>{
        const linea=it.precio*it.qty;
        cont.append(`
        <div class="grid grid-cols-12 gap-2 items-center py-2">
          <div class="col-span-5">
            <div class="font-medium">${it.nombre}</div>
            <div class="text-xs text-gray-500">${$fmt(it.precio)} c/u</div>
          </div>
          <div class="col-span-3">
            <input type="number" min="1" value="${it.qty}" data-id="${it._rowId}" data-action="qty" class="inp w-24"/>
          </div>
          <div class="col-span-3 text-right font-semibold">${$fmt(linea)}</div>
          <div class="col-span-1 text-right">
            <button class="btn btn-ghost text-xs px-2 py-1" data-id="${it._rowId}" data-action="del">âœ•</button>
          </div>
        </div>`);
      });
    }
    const total = CART.reduce((a,x)=>a+x.precio*x.qty,0);
    const costo = CART.reduce((a,x)=>a+(Number(x.costo)||0)*x.qty,0);
    $('#totalBruto').text($fmt(total)); $('#totalCosto').text($fmt(costo)); $('#totalGanancia').text($fmt(total-costo));
    const pago = Number($('#pago').val()||m.pago||0); const vuelto = Math.max(0, pago-total); $('#vuelto').text($fmt(vuelto));
  }

  // ---------- API: guardar pedido ----------
  async function saveOrder(){
    const m=mesaActual(); if(!m) return;
    if(!ORDERS_WEBAPP_URL){ alert('Configura ORDERS_WEBAPP_URL'); return; }
    if(m.items.length===0){ alert('El carrito estÃ¡ vacÃ­o.'); return; }

    for(const it of m.items){
      const p = MENU.find(x=>x._rowId===it._rowId);
      if(controlsStock(p)){
        const disp = availableStock(p);
        if(it.qty > disp){
          alert(`No hay stock suficiente de "${p.nombre}". Disponible: ${disp}.`);
          return;
        }
      }
    }

    const total = m.items.reduce((a,x)=>a+x.precio*x.qty,0);
    const totalCosto = m.items.reduce((a,x)=>a+(Number(x.costo)||0)*x.qty,0);
    const payload = {
      timestamp:new Date().toISOString(),
      cliente:m.cliente||'',
      mesa:m.nombre,color:m.color,total, totalCosto, ganancia: total-totalCosto,
      pago: Number(m.pago||0),
      items: m.items.map(x=>({nombre:x.nombre,precio:x.precio,costo:x.costo,qty:x.qty}))
    };

    $('#btnGuardar').prop('disabled',true).text('Guardandoâ€¦');
    try{
      const res = await fetch('/.netlify/functions/gs-order', {
        method:'POST',
        headers:{'Content-Type':'application/x-www-form-urlencoded;charset=UTF-8'},
        body:'payload='+encodeURIComponent(JSON.stringify(payload))
      });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      let data;
      try { data = await res.json(); }
      catch { throw new Error('Respuesta no-JSON del servidor'); }
      if (data.ok !== true || data.marker !== 'SALE_RECEIVED') {
        throw new Error(data.error || 'Servidor no confirmÃ³ la venta');
      }
      alert(`Pedido guardado âœ…`);
      m.items=[]; renderCart(); saveState(); renderProducts();
      await loadMenuFromSheet(); // refrescar stocks desde Sheet
    }catch(err){
      console.error(err);
      alert('No se pudo guardar el pedido: '+err.message);
    }finally{
      $('#btnGuardar').prop('disabled',false).text('Guardar Pedido');
    }
  }

  // ---------- API: menÃº & stock ----------
  async function loadMenuFromSheet(){
    const res = await fetch(`${API}?action=menu`, { method: 'GET' });
    const json = await res.json();
    if (!json.ok) throw new Error(json.error || 'No pude cargar el menÃº');

   
     const items = (json.items || []).map((x, idx) => {
  const sku = (x.sku ?? '').toString().trim();
  const nombre = (x.nombre ?? '').toString().trim();
  const rawStock = x.stock;
  const stock = (rawStock === '' || rawStock === null || rawStock === undefined) ? null : Number(rawStock);
  return {
    sku,
    nombre,
    categoria: x.categoria ?? '',
    subcategoria: x.subcategoria ?? '',
    precio: Number(x.precio ?? 0),
    costo: Number(x.costo ?? 0),
    stock,
    _rowId: sku || nombre || `r${idx}`
  };
});
MENU = items;
window.MENU = items;

// (opcional) reset filtros antes de pintar
$('#categoria').val('');
$('#subcategoria').val('');
$('#buscar').val('');

// ahora sÃ­, render
renderFilters();
renderProducts();
renderMesas();

const $badge = document.getElementById('statusBadge');
if ($badge) $badge.textContent = 'MenÃº sincronizado';
console.log('MENU cargado:', MENU.length, MENU.slice(0,3));
  }

  async function setStock(sku, newStock){
    const payload = { items: [{ sku, stock: Number(newStock) }] };
    const body = new URLSearchParams({
      action: 'setStock',
      data: JSON.stringify(payload)
    }).toString();

    const res = await fetch(API, {
      method: 'POST',
      headers: { 'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8' },
      body
    });
    const json = await res.json();
    if (!json.ok) throw new Error(json.error || 'No se pudo actualizar stock');

    const p = MENU.find(x => x.sku === sku);
    if (p) p.stock = Number(newStock);
    await loadMenuFromSheet();
  }

  // ---------- ImpresiÃ³n ----------
  function printSection(sectionId){
    const a = document.getElementById('ticketCliente');
    const b = document.getElementById('comandaCocina');
    if(a) a.classList.remove('print-active');
    if(b) b.classList.remove('print-active');
    const target = document.getElementById(sectionId);
    if(target) target.classList.add('print-active');
    window.print();
    setTimeout(()=>{ if(target) target.classList.remove('print-active'); }, 250);
  }
  function buildTicketCliente(m){}
  function buildComandaCocina(m){}

  // ---------- Eventos ----------
  function bindEvents(){
    $('#btnNuevaMesa').on('click', ()=> nuevaMesa());
    $('#listaMesas').on('click','[data-action="switch"]', function(){ MESA_ACTUAL=$(this).data('id'); renderMesas(); });
    $('#listaMesas').on('click','[data-action="rename"]', function(){ const id=$(this).data('id'); const m=MESAS.find(x=>x.id===id); if(!m) return; const nv = prompt('Nuevo nombre', m.nombre); if(nv){ m.nombre=nv; if(MESA_ACTUAL===id) $('#mesaTitulo').text(nv); renderMesas(); } });
    $('#listaMesas').on('click','[data-action="dup"]', function(){ duplicarMesa($(this).data('id')); });
    $('#listaMesas').on('click','[data-action="del"]', function(){ eliminarMesa($(this).data('id')); });
    $('#colorMesa').on('input', function(){ cambiarColorActual($(this).val()); });
    $('#stockMinGlobal').on('input', ()=> renderProducts());
    $('#categoria').on('change', function(){ renderSubcats(); renderProducts(); });
    $('#subcategoria, #buscar').on('input change', renderProducts);

    // FIX robusto para "Agregar"
    $('#listaProductos').on('click','button[data-action="add"]', function(){
      let id = $(this).attr('data-id') || $(this).data('id');
      if (!id) {
        console.warn('ADD sin data-id en el botÃ³n', this);
        alert('No pude identificar el producto. ActualizÃ¡ el menÃº e intentÃ¡ de nuevo.');
        return;
      }
      addToCart(String(id));
    });

    $('#listaProductos').on('click','[data-action="edit-stock"]', async function(){
      const sku = String($(this).data('sku') || '').trim();
      if (!sku) return;
      const p = MENU.find(x => x.sku === sku);
      const actual = Number(p?.stock ?? 0);
      const nv = prompt(`Nuevo stock para ${p?.nombre || sku}:`, actual);
      if (nv == null) return;
      const newStock = Number(nv);
      if (!Number.isFinite(newStock) || newStock < 0) { alert('Stock invÃ¡lido'); return; }
      try{
        await setStock(sku, newStock);
      }catch(e){
        console.error(e);
        alert('No se pudo actualizar el stock: '+ (e?.message || e));
      }
    });

    $('#cartTable').on('click','button[data-action="del"]', function(){ removeFromCart($(this).data('id')); });
    $('#cartTable').on('input','input[data-action="qty"]', function(){ setQty($(this).data('id'), $(this).val()); });

    $('#cliente').on('input', function(){ const m=mesaActual(); if(!m) return; m.cliente=$(this).val(); saveState(); });
    $('#pago').on('input', function(){ const m=mesaActual(); if(!m) return; m.pago=Number($(this).val()||0); renderCart(); saveState(); });
    $('#btnVaciar').on('click', function(){ const m=mesaActual(); if(!m) return; m.items=[]; renderCart(); saveState(); renderProducts(); });
    $('#btnDuplicarMesa').on('click', function(){ duplicarMesa(MESA_ACTUAL); });
    $('#btnGuardar').on('click', saveOrder);
    $('#btnTicket').on('click', ()=>printSection('ticketCliente'));
    $('#btnComanda').on('click', ()=>printSection('comandaCocina'));
  }

  function nuevaMesa(nombre='Mesa '+(MESAS.length+1), color='var(--accent-600)'){
    const m = { id:uid(), nombre, color:'#fb8c00', items:[], cliente:'', pago:0 };
    MESAS.push(m); MESA_ACTUAL=m.id; renderMesas();
  }
  function duplicarMesa(id){
    const src = MESAS.find(m=>m.id===id); if(!src) return;
    const copy = { ...src, id:uid(), nombre: src.nombre+" (copia)", items: JSON.parse(JSON.stringify(src.items)) };
    MESAS.push(copy); MESA_ACTUAL=copy.id; renderMesas();
  }
  function eliminarMesa(id){
    if(MESAS.length===1){ alert('Debe quedar al menos una mesa.'); return; }
    MESAS = MESAS.filter(m=>m.id!==id);
    if(MESA_ACTUAL===id){ MESA_ACTUAL = MESAS[0].id; }
    renderMesas();
  }
  function cambiarColorActual(color){ const m=mesaActual(); if(!m) return; m.color=color; $('#cartWrapper').css('border-color', color); saveState(); renderMesas(); }

  // ---------- Init ----------
  $(async function(){
    loadState();
    bindEvents();
    renderMesas();
    await loadMenuFromSheet();
  });
  </script>
</body>
</html>
